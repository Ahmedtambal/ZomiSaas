igh-Level Conceptual Overview
Your database is designed as a secure, multi-tenant system. The core principle is that all data is partitioned by an organization_id. This acts like a digital keycard: a user from one organization can never access the "room" containing another organization's data. This is enforced at the database level by Row Level Security (RLS), making it extremely secure and compliant.
The workflow is: Raw data comes into the forms table, is processed and validated into the employees table, which is enriched with rules from the companies table.
Database Schema Diagram
This diagram shows how the tables are related to each other.
code
Code
[ AUTHENTICATION ]
   + auth.users [PK: id]
       |
       +---------------------------------+
                                         |
[ USER & ORGANIZATION MANAGEMENT ]       |
   + user_profiles [PK: id, FK: organization_id]
       |             |
       |             +--------------------+
       |                                  |
   + organizations [PK: id] <-------------+
       |
       +-----------------------------------------------------------------+
                                                                         |
[ CORE APPLICATION DATA - All linked to an Organization ]                |
                                                                         |
   + companies (The Rulebook)                                            |
     - id [PK]                                                           |
     - organization_id [FK to organizations] ----------------------------+
     - name                                                              |
     - scheme_ref, is_smart_pension, etc.                                |
       |                                                                 |
       +-------------------------------------------------+               |
                                                         |               |
   + forms (The Inbox)                                   |               |
     - id [PK]                                           |               |
     - organization_id [FK to organizations] ------------+               |
     - matched_company_id [FK to companies] -------------+               |
     - form_data [JSONB]                                                 |
       |                                                                 |
       +---------------------------------+                               |
                                         |                               |
   + employees (The Master Data)         |                               |
     - id [PK]                           |                               |
     - organization_id [FK to organizations] ------------+               |
     - company_id [FK to companies] ---------------------+               |
     - source_form_id [FK to forms] ---------------------+               |
     - first_name, ni_number, etc.                                       |
       |                                                                 |
       +---------------------------------+                               |
                                         |                               |
   + change_log (The Audit Trail)        |                               |
     - id [PK]                           |                               |
     - employee_id [FK to employees] ----+                               |
     - changed_by_user_id [FK to user_profiles]                          |
     - old_value, new_value                                              |

[ DATA INTEGRITY - Lookup Tables ]
   + lookup_titles, lookup_genders, etc.
     - id [PK]
     - value [UNIQUE]
Detailed Table-by-Table Breakdown
1. public.companies
Purpose: The Master Rulebook. This pre-filled table stores all the unique pension schemes, benefit rules, and IO export settings for each of your corporate clients.
Key Columns:
id (Primary Key): Unique identifier for the company.
organization_id (Foreign Key): The security link. Connects this company to your master organization.
name: The official name of the client company.
scheme_ref, category_name, is_smart_pension, has_group_life, etc.: The specific rules and settings for this company.
Row Level Security (RLS) Policies:
Read: You can only see companies that belong to your organization.
Write (Create/Update): You can only create or modify companies that belong to your organization.
Delete: Only users with the admin role in your organization can delete a company.
2. public.forms
Purpose: The Raw Data Inbox. This table acts as a staging area, capturing the exact, unprocessed data submitted through your "New Employee" web form.
Key Columns:
id (Primary Key): Unique identifier for a single form submission.
organization_id (Foreign Key): The security link.
form_data (JSONB): A flexible field that stores the entire form submission (e.g., first name, DOB) as a single JSON object.
processing_status: A workflow flag for your team (e.g., "Pending Review", "Processed").
Row Level Security (RLS) Policies:
Read/Write/Delete: The same rules as the companies table apply. You can only manage form submissions that are linked to your organization.
3. public.employees
Purpose: The Master Employee Database. This is the central, authoritative table for all clean, validated, and structured member data, ready for management and export.
Key Columns:
id (Primary Key): Unique identifier for an employee.
organization_id (Foreign Key): The security link.
company_id (Foreign Key): Links the employee to their specific set of rules in the companies table.
source_form_id (Foreign Key): Provides a traceable link back to the original submission in the forms table.
first_name, surname, ni_number, pensionable_salary: The core PII and financial data.
pension_start_date, io_upload_status: The automated and manual status fields that drive your workflow.
Row Level Security (RLS) Policies:
Read/Write/Delete: The same rules as the companies table apply. You can only manage employee records that belong to your organization.
4. public.lookup_* (e.g., lookup_titles, lookup_nationalities)
Purpose: The Data Integrity Guards. These small tables hold the pre-approved lists of accepted values for dropdown fields, preventing data entry errors and ensuring consistency.
Key Columns:
id (Primary Key): Unique identifier for the lookup value.
value (Text, Unique): The actual text that will be stored and displayed (e.g., "Married", "British").
Row Level Security (RLS) Policies:
Read: Any authenticated user (i.e., anyone logged in) can read these lists to populate dropdown menus in the user interface.
Write/Delete: By default, no one can change these lists. Only a database administrator with elevated privileges should be able to add or remove a nationality or title.
5. public.change_log (To be created)
Purpose: The Compliance Audit Trail. This table will create a permanent, unchangeable record of every single modification made to an employee's data, satisfying FCA requirements.
Key Columns:
id (Primary Key): Unique identifier for a single change event.
employee_id (Foreign Key): Shows which employee's record was modified.
changed_by_user_id (Foreign Key): Shows which team member made the change.
old_value / new_value: The data before and after the change.
Row Level Security (RLS) Policies:
Read: You can only see the change history for employees who belong to your organization.
Write: This table should be write-only from the application via database triggers. Users should not be able to directly modify or delete log entries.



create table public.user_profiles (
  id uuid not null,
  organization_id uuid not null,
  full_name text not null,
  job_title text null,
  role text not null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  constraint user_profiles_pkey primary key (id),
  constraint user_profiles_id_fkey foreign KEY (id) references auth.users (id) on delete CASCADE,
  constraint user_profiles_organization_id_fkey foreign KEY (organization_id) references organizations (id) on delete CASCADE,
  constraint user_profiles_role_check check ((role = any (array['admin'::text, 'user'::text])))
) TABLESPACE pg_default;

create index IF not exists idx_user_profiles_organization_id on public.user_profiles using btree (organization_id) TABLESPACE pg_default;

create index IF not exists idx_user_profiles_role on public.user_profiles using btree (role) TABLESPACE pg_default;

create trigger update_user_profiles_updated_at BEFORE
update on user_profiles for EACH row
execute FUNCTION update_updated_at_column ();


create table public.organizations (
  id uuid not null default extensions.uuid_generate_v4 (),
  name text not null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  is_active boolean null default true,
  constraint organizations_pkey primary key (id),
  constraint organizations_name_key unique (name),
  constraint org_name_min_length check ((char_length(name) >= 2))
) TABLESPACE pg_default;

create index IF not exists idx_organizations_name on public.organizations using btree (name) TABLESPACE pg_default;

create index IF not exists idx_organizations_active on public.organizations using btree (is_active) TABLESPACE pg_default;

create trigger update_organizations_updated_at BEFORE
update on organizations for EACH row
execute FUNCTION update_updated_at_column ();


create table public.forms (
  id uuid not null default gen_random_uuid (),
  organization_id uuid not null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  created_by_user_id uuid null,
  matched_company_id uuid null,
  form_data jsonb null,
  processing_status text not null default 'Pending Review'::text,
  constraint forms_pkey primary key (id),
  constraint forms_created_by_user_id_fkey foreign KEY (created_by_user_id) references auth.users (id) on delete set null,
  constraint forms_matched_company_id_fkey foreign KEY (matched_company_id) references companies (id) on delete set null,
  constraint forms_organization_id_fkey foreign KEY (organization_id) references organizations (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_forms_organization_id on public.forms using btree (organization_id) TABLESPACE pg_default;

create index IF not exists idx_forms_processing_status on public.forms using btree (processing_status) TABLESPACE pg_default;

create trigger handle_forms_updated_at BEFORE
update on forms for EACH row
execute FUNCTION moddatetime ();


create table public.employees (
  id uuid not null default gen_random_uuid (),
  organization_id uuid not null,
  company_id uuid not null,
  source_form_id uuid null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  title text null,
  first_name text not null,
  surname text not null,
  ni_number text null,
  date_of_birth date null,
  gender text null,
  marital_status text null,
  address_line_1 text null,
  address_line_2 text null,
  address_line_3 text null,
  address_line_4 text null,
  city_town text null,
  county text null,
  country text null,
  postcode text null,
  email_address text null,
  home_number text null,
  mobile_number text null,
  uk_resident boolean null,
  nationality text null,
  pensionable_salary numeric null,
  pensionable_salary_start_date date null,
  salary_post_sacrifice numeric null,
  employment_start_date date null,
  date_joined_scheme date null,
  selected_retirement_age integer null,
  pension_investment_approach text null,
  policy_number text null,
  split_template_group_name text null,
  split_template_group_source text null,
  service_status text null default 'Active'::text,
  client_category text null,
  pension_start_date date null,
  io_upload_status boolean not null default false,
  constraint employees_pkey primary key (id),
  constraint employees_gender_fkey foreign KEY (gender) references lookup_genders (value),
  constraint employees_marital_status_fkey foreign KEY (marital_status) references lookup_marital_statuses (value),
  constraint employees_nationality_fkey foreign KEY (nationality) references lookup_nationalities (value),
  constraint employees_organization_id_fkey foreign KEY (organization_id) references organizations (id) on delete CASCADE,
  constraint employees_pension_investment_approach_fkey foreign KEY (pension_investment_approach) references lookup_pension_investment_approaches (value),
  constraint employees_source_form_id_fkey foreign KEY (source_form_id) references forms (id) on delete set null,
  constraint employees_company_id_fkey foreign KEY (company_id) references companies (id) on delete CASCADE,
  constraint employees_title_fkey foreign KEY (title) references lookup_titles (value)
) TABLESPACE pg_default;

create index IF not exists idx_employees_organization_id on public.employees using btree (organization_id) TABLESPACE pg_default;

create index IF not exists idx_employees_company_id on public.employees using btree (company_id) TABLESPACE pg_default;

create index IF not exists idx_employees_service_status on public.employees using btree (service_status) TABLESPACE pg_default;

create index IF not exists idx_employees_io_upload_status on public.employees using btree (io_upload_status) TABLESPACE pg_default;

create trigger handle_employees_updated_at BEFORE
update on employees for EACH row
execute FUNCTION moddatetime ();


create table public.companies (
  id uuid not null default gen_random_uuid (),
  organization_id uuid not null,
  created_at timestamp with time zone not null default now(),
  name text not null,
  is_pension_active boolean null default false,
  is_smart_pension boolean null default false,
  send_pension_pack boolean null default false,
  postponement_period text null,
  pension_provider_info text null,
  scheme_ref text null,
  category_name text null,
  advice_type text null,
  selling_adviser_id text null,
  has_group_life boolean null default false,
  has_gci boolean null default false,
  has_gip boolean null default false,
  has_bupa boolean null default false,
  operational_notes text null,
  constraint companies_pkey primary key (id),
  constraint unique_company_name_for_org unique (organization_id, name),
  constraint companies_organization_id_fkey foreign KEY (organization_id) references organizations (id) on delete CASCADE
) TABLESPACE pg_default;

create index IF not exists idx_companies_organization_id on public.companies using btree (organization_id) TABLESPACE pg_default;
create table public.audit_logs (
  id uuid not null default extensions.uuid_generate_v4 (),
  organization_id uuid null,
  action text not null,
  resource text null,
  details jsonb null,
  ip_address inet null,
  user_agent text null,
  created_at timestamp with time zone null default now(),
  user_id uuid null,
  constraint audit_logs_pkey primary key (id),
  constraint audit_logs_organization_id_fkey foreign KEY (organization_id) references organizations (id) on delete CASCADE,
  constraint audit_logs_user_id_fkey foreign KEY (user_id) references auth.users (id) on delete set null
) TABLESPACE pg_default;

create index IF not exists idx_audit_logs_organization on public.audit_logs using btree (organization_id) TABLESPACE pg_default;

create index IF not exists idx_audit_logs_action on public.audit_logs using btree (action) TABLESPACE pg_default;

create index IF not exists idx_audit_logs_created_at on public.audit_logs using btree (created_at) TABLESPACE pg_default;

